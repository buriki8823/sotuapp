<div class="position-relative py-0" style="background-image: url(<%= asset_path('posts-bg.png') %>); background-size: cover; background-position: top center; background-repeat: no-repeat; width: 100%; min-height: 100vh; margin: 0;">
  <div class="container py-4">
    <h1 class="toukou-title text-center mt-3 mb-5" style="position: relative; top: 30px; font-size: 128px;">ブックマーク一覧</h1>

    <% if @bookmarked_posts.any? %>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" style="max-width: 1500px; margin: 100px auto;">
        <% @bookmarked_posts.each do |post| %>
          <div class="col">
            <div class="card h-100 shadow-sm">
              <%= link_to post_path(post), class: "d-block" do %>
                <%= image_tag post.first_image_url_or_placeholder, alt: "投稿画像", style: "width: calc(100% - 24px); height: 230px; object-fit: cover; margin: 12px; border: 1px solid #ccc; border-radius: 6px;" %>
              <% end %>
              <div class="card-body">
                <h5 class="card-title"><%= post.title %></h5>
                <p class="card-text text-muted">投稿者：<%= post.user.name %></p>
                <button class="btn btn-sm btn-outline-danger mt-2 bookmark-remove-button" data-post-id="<%= post.id %>">
                  ブックマーク解除
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <div class="d-flex justify-content-center mt-5">
        <%= paginate @bookmarked_posts %>
      </div>
    <% else %>
      <div class="text-center mt-5">
        <p class="text-muted" style="font-size: 24px;">まだブックマークはありません。</p>
        <%= link_to "投稿一覧を見る", posts_path, class: "btn btn-outline-primary mt-3" %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".bookmark-remove-button");
  if (buttons.length === 0) return;

  buttons.forEach(button => {
    button.addEventListener("click", () => {
      const postId = button.dataset.postId;
      const csrfToken = document.querySelector("[name='csrf-token']")?.content;
      if (!csrfToken || !postId) return;

      fetch(`/posts/${postId}/bookmark`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRF-Token": csrfToken
        }
      })
      .then(response => {
        if (!response.ok) throw new Error("通信失敗");
        return response.json(); // ← JSONを期待する
      })
      .then(data => {
        if (data.status === "unbookmarked") {
          const card = button.closest(".card");
          if (card) {
            const col = card.closest(".col");
            if (col) col.remove();
          }
        }
      })
      .catch(error => {
        console.error("ブックマーク解除エラー:", error);
        alert("ブックマーク解除に失敗しました");
      });
    });
  });
});
</script>