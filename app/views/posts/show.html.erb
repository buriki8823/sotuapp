<div class="position-relative py-0" style="background-image: url(<%= asset_path('posts-bg.png') %>); background-size: cover; background-position: top center; background-repeat: no-repeat; width: 100%; min-height: 100vh; margin: 0;">

  <div style="position: absolute; left: 10; right: 0; z-index: 10;">
    <%= render "shared/navigation_box" %>
  </div>

  <h1 class="toukou-title text-center mb-5" style="position: relative; top: 60px; font-size: 100px;"><%= @post.title %></h1>  

  <% if @post.image_urls.present? %>
    <div class="d-flex gap-2 justify-content-center mb-5" style="max-width: 1500px; margin: 0 auto;">
    
      <!-- 左：画像 -->
      <div class="swiper mySwiper rounded shadow-sm overflow-hidden">
        <div class="swiper-wrapper">
          <% @post.image_urls.each do |url| %>
            <div class="swiper-slide">
              <%= image_tag url.sub("/upload/", "/upload/c_fill,w_800,h_600,g_auto/"), class: "w-100 h-100", alt: "投稿画像", style: "object-fit: cover;" %>
            </div>
          <% end %>
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>

      <!-- Swiperのカスタムスタイル -->
      <style>
        .swiper-button-next svg,
        .swiper-button-prev svg {
          display: none;
        }

        .swiper-button-next::after {
          content: '▶'; 
          color: red; !important;
          font-size: 32px; !important;
        }

        .swiper-button-prev::after {
          content: '◀'; 
          color: red;  !important;
          font-size: 32px; !important;
          font-weight: bold; !important;
        }

        .swiper-pagination-bullet {
          background-color: red !important;
          opacity: 1;
        }

        .swiper-pagination-bullet-active {
          background-color: darkred !important;
        }
      </style>


      <!-- 右：投稿者情報ボックス -->
      <div class="p-4 rounded shadow-sm"
           style="position: relative; background-color: #ffffff; border: 2px solid #000; overflow-y: auto; margin-top: 20px; margin-right: 24px;">
          <div class="d-flex align-items-center mb-4" style="border-bottom: 2px solid #000; padding-bottom: 10px;">
            <%= image_tag @post.user.avatar_url.presence || "default_avatar.png", alt: "投稿者アイコン", class: "rounded-circle me-3", style: "position: relative; left: 10px; width: 64px; height: 64px; object-fit: cover;" %>
            <h4 class="fw-bold mb-0" style="position: relative; left: 20px;"><%= @post.user.name %></h4>
          </div>

          <% if user_signed_in? %>
            <div class="bookmark-toggle" data-post-id="<%= @post.id %>" data-bookmarked="<%= @bookmarked %>">
              <button class="btn bookmark-button" style="background-color: <%= @bookmarked ? '#dc3545' : 'orange' %>; color: white; margin-bottom: 10px;">
                <i class="bi <%= @bookmarked ? 'bi-bookmark-x' : 'bi-bookmark-plus' %> me-2"></i>
                <%= @bookmarked ? 'ブックマーク解除' : 'ブックマークする' %>
              </button>
            </div>
          <% end %>

          <%= link_to "ブックマーク一覧へ", bookmarks_path, class: "btn w-100", style: "background-color: #6c757d; color: white;" %>
          
          <% if current_user == @post.user %>
            <%= button_to post_path(@post),
                method: :delete,
                data: { confirm: "本当に削除しますか？" },
                params: {},
                class: "btn btn-danger",
                style: "z-index: 10; position: absolute; bottom: 8px; right: 8px;" do %>
              投稿を削除
            <% end %>
          <% end %>
      </div>

    </div>
  <% else %>
    <p class="text-center text-muted">画像は投稿されていません</p>
  <% end %>

  <!-- 感性評価ボタン -->
  <div style="max-width: 1500px; margin: 0 auto;">
    <div class="d-flex flex-wrap align-items-center justify-content-center gap-4 mb-5">

      <!-- 感性評価ボタン群 -->
      <div class="d-flex flex-wrap gap-3"style="margin-right: 50px;">
        <% Evaluation.kinds.each do |kind, _| %>
          <% evaluated = @post.evaluations.exists?(user: current_user, kind: kind) %>

          <%= form_with url: evaluate_post_path(@post, kind: kind), method: :post, local: false do %>
            <%= button_tag type: "submit",
                class: "btn px-4 py-2 rounded-pill kind-button #{evaluated ? 'btn-success' : 'btn-outline-secondary'}",
                data: { kind: kind, post_id: @post.id } do %>
              <%= kind_icon(kind) %> <%= kind_label(kind) %>
            <% end %>
          <% end %>
        <% end %>
      </div>

      <!-- ★評価 -->
      <% if @post.rating_enabled? %>
        <% avg_score = @post.average_star_score.to_f.round %>
        <div class="star-rating" data-post-id="<%= @post.id %>" style="position: relative;">
          <div class="star-display" style="cursor: pointer;">
           <% (1..5).each do |i| %>
              <span class="star <%= 'selected' if i <= avg_score %>" data-score="<%= i %>">★</span>
           <% end %>
            <span class="ms-2 text-muted">（平均：<%= @post.average_star_score %>点）</span>
          </div>

          <div class="score-dropdown" style="display: none; position: absolute; top: 40px; left: 0; background: white; border: 1px solid #ccc; padding: 8px; border-radius: 4px; z-index: 100;">
            <% (1..5).each do |i| %>
              <div class="score-option" data-score="<%= i %>" style="cursor: pointer; padding: 4px 8px;">
               <%= "★" * i %>（<%= i %>点）
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <% else %>
      <% end %>
  </div>

  <!-- お部屋説明 -->
  <div style="max-width: 1500px; margin: 0 auto;">
    <h3 class="fw-bold mb-3" style="text-align: left;">お部屋説明</h3>

    <div class="rounded-4 shadow-sm p-2 mb-5"
         style="background-color: #ffffff; border: 2px solid #000; min-height: 200px;">
      <div style="font-size: 25px; line-height: 1.6;"><%= simple_format(@post.body) %></div>
    </div>
  </div>


  <!-- オススメグッズ -->
  <% visible_products = @post.products.select do |product| %>
    <% [product.title, product.description, product.image_url].any?(&:present?) %>
  <% end %>
  <% if visible_products.any? %>
    <!-- 左上に見出し -->
    <div style="max-width: 1500px; margin: 0 auto;">
      <h2 class="fw-bold mb-4">オススメグッズ</h2>

      <!-- 商品カード群 -->
      <div class="d-flex flex-column gap-5 mb-5">
        <% visible_products.each do |product| %>
          <div class="d-flex gap-4 align-items-center p-4 shadow-sm rounded mx-auto mb-0"
               style="position: relative; top: -10px; width: 1500px; height: 300px; background-color: #ffffff; border: 2px solid #000;">
            <% if product.image_url.present? %>
              <div class="product-image-wrapper">
                <%= image_tag product.image_url, class: "product-image" %>
              </div>
            <% end %>
            <div class="product-text-area">
              <h2 class="fw-bold fs-2 mb-3" style="position: relative; left: 10px;"><%= product.title %></h2>
              <div class="p-1 rounded-3 border" style="background-color: #ffffff; border-color: #000;">
                <p class="fs-5 lh-lg mb-0"><%= simple_format(product.description) %></p>
              </div>
              <% if product.url.present? %>
                <a href="<%= product.url %>" target="_blank" class="btn btn-success mt-3">商品ページを見る</a>
              <% else %>
                <p class="text-muted mt-3">URLはありません</p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>


  <!-- コメント投稿フォーム -->
  <div id="comment-form" class="mx-auto" style="max-width: 1500px;">
    <h3 class="fw-bold mb-3">コメントを投稿する</h3>
    <%= form_with(model: [@post, Comment.new], local: false, data: { turbo: false }, id: "comment-form") do |f| %>
      <div class="mb-3">
        <%= f.text_area :body, rows: 4, class: "form-control", placeholder: "コメントを入力してください" %>
      </div>
      <%= f.submit "投稿", class: "btn btn-primary" %>
    <% end %>
  </div>

  <!-- コメント一覧 -->
  <div class="mx-auto" style="position: relative; top: -20px; margin-top: 50px; max-width: 1500px;">
    <h3>コメント一覧</h3>
    <div id="comment-list">
      <% @post.comments.each do |comment| %>
        <div class="p-3 rounded shadow-sm" style="margin-top: 10px; background-color: #fff; border: 1px solid #ccc;">
          <p class="mb-1"><strong><%= comment.user.name %></strong></p>
          <hr style="margin-top: 5px; margin-bottom: 10px; border-top: 1px solid #999;">
          <p class="mb-0"><%= simple_format(comment.body) %></p>
        </div>
      <% end %>
    </div>
  </div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    new Swiper(".mySwiper", {
      loop: true,
      pagination: {
        el: ".swiper-pagination",
        clickable: true,
      },
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".star-rating").forEach(rating => {
      const display = rating.querySelector(".star-display");
      const dropdown = rating.querySelector(".score-dropdown");
      const postId = rating.dataset.postId;

      display.addEventListener("click", () => {
        dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
      });

      dropdown.querySelectorAll(".score-option").forEach(option => {
        option.addEventListener("click", () => {
          const score = parseInt(option.dataset.score);
          fetch(`/posts/${postId}/star_ratings`, {
            method: "POST",
            headers: {
               "Content-Type": "application/json",
               "X-CSRF-Token": document.querySelector("[name='csrf-token']").content
            },
            body: JSON.stringify({ post_id: postId, score: score })
          })
          .then((response) => {
            if (!response.ok) {
              throw new Error("サーバーエラー: " + response.status);
            }
            dropdown.style.display = "none";
            location.reload(); // 成功時のみリロード
          })
          .catch((error) => {
            console.error("評価送信エラー:", error);
            alert("評価の送信に失敗しました。もう一度お試しください。");
          });
        });
      });
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".bookmark-toggle").forEach(container => {
      const button = container.querySelector(".bookmark-button");
      const postId = container.dataset.postId;
      let bookmarked = container.dataset.bookmarked === "true";

      if (!button || !postId) return;

      button.addEventListener("click", () => {
        const method = bookmarked ? "DELETE" : "POST";
        const csrfToken = document.querySelector("[name='csrf-token']")?.content;
        if (!csrfToken) return;

        fetch(`/posts/${postId}/bookmark`, {
          method: method,
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRF-Token": csrfToken
          }
        })
        .then(response => {
          if (!response.ok) throw new Error("通信失敗: " + response.status);
          return response.json(); // JSONレスポンスを読む
        })
        .then(data => {
          if (data.status === "bookmarked") {
            bookmarked = true;
          } else if (data.status === "unbookmarked") {
            bookmarked = false;
          }

          container.dataset.bookmarked = bookmarked.toString();
          button.innerHTML = bookmarked
            ? '<i class="bi bi-bookmark-x me-2"></i>ブックマーク解除'
            : '<i class="bi bi-bookmark-plus me-2"></i>ブックマークする';
          button.style.backgroundColor = bookmarked ? "#dc3545" : "orange";
        })
        .catch(error => {
          console.error("ブックマーク切り替えエラー:", error);
          alert("ブックマークの切り替えに失敗しました");
        });
      });
    });
  });

  document.addEventListener("submit", (event) => {
    event.preventDefault(); // ← これがないと遷移する
    const form = event.target;

    fetch(form.action, {
      method: form.method,
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector("[name='csrf-token']").content
      },
      body: JSON.stringify({
        comment: {
          body: form.querySelector("textarea[name='comment[body]']").value
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      const commentList = document.querySelector("#comment-list");
      const newComment = document.createElement("div");
      newComment.className = "p-3 rounded shadow-sm";
      newComment.style = "margin-top: 10px; background-color: #fff; border: 1px solid #ccc;";
      newComment.innerHTML = `
        <p class="mb-1"><strong>${data.user_name}</strong></p>
        <hr style="margin-top: 5px; margin-bottom: 10px; border-top: 1px solid #999;">
        <p class="mb-0">${data.body}</p>
      `;
      commentList.prepend(newComment);
      form.reset();
    })
    .catch(error => {
      console.error("コメント送信エラー:", error);
      alert("コメントの投稿に失敗しました");
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".kind-button").forEach(button => {
      button.addEventListener("click", () => {
        const postId = button.dataset.postId;
        const kind = button.dataset.kind;
        const csrfToken = document.querySelector("[name='csrf-token']")?.content;
        if (!csrfToken || !postId || !kind) return;

        fetch(`/posts/${postId}/evaluate/${kind}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRF-Token": csrfToken
          }
        })
        .then(response => {
          if (!response.ok) throw new Error("通信失敗");
          return response.json();
        })
        .then(data => {
          if (data.status === "evaluated") {
            button.classList.remove("btn-outline-secondary");
            button.classList.add("btn-success");
          } else if (data.status === "unevaluated") {
            button.classList.remove("btn-success");
            button.classList.add("btn-outline-secondary");
          }
        })
        .catch(error => {
          console.error("評価エラー:", error);
          alert("評価に失敗しました");
        });
      });
    });
  });
</script>

<style>
@media (min-width: 769px) {
  .p-4.rounded.shadow-sm {
    height: 400px !important;   /* ← PCでは固定高さ */
    width: 300px;
    flex: 0 0 auto; /* ← 必要なら柔軟に */
  }

  .btn.bookmark-button {
    width: 100% !important;
  }

  .swiper.mySwiper {
    width: 1300px;       /* PC用横幅 */
    height: 600px;      /* PC用高さ */
    margin: 20px 0 0 100px;
  }
  
  .product-image-wrapper {
    width: 400px;
    height: 100%;
    flex-shrink: 0;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-text-area {
    flex: 1 1 auto;   /* 必要な分だけ広がる */
    width: 100%;      /* スマホでは幅いっぱい */
  }

  .fw-bold mb-4 {
    font-size: 48px
    text-align: left;
  }
}

@media (max-width: 768px) {
  /* タイトル */
  .toukou-title {
    font-size: 32px !important;
    margin-bottom: 70px !important;
    top: 50px !important;
  }

  /* Swiper画像 */
  .swiper-slide {
    height: 200px !important;
  }


  .swiper.mySwiper {
    height: 200px !important;
    margin: 0 auto !important; /* 中央寄せ */
  }


  .swiper.mySwiper img {
    width: 100% !important;
    height: auto !important;
    object-fit: cover !important;
  }

  #swiper-wrapper {
    height: 200px !important;
  }


  /* 親コンテナを縦並びに */
  .d-flex.gap-2.justify-content-center {
    flex-direction: column !important;
    align-items: center !important;
    margin: 0 0 20px 0 !important;
  }


  .w-100.h-100 {
    height: 200px !important;   /* ← スマホ用に高さを調整 */
    object-fit: cover !important;
  }

  /* 投稿者情報ボックス */
  .p-4.rounded.shadow-sm {
    order: -1;
    width: 95% !important;
    height: 130px !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 15px !important;
  }


  .p-4.rounded.shadow-sm img {
    width: 48px !important;
    height: 48px !important;
  }

  .p-4.rounded.shadow-sm img.rounded-circle.me-3 {
    position: relative !important;
    left: 50px !important;
  }

  .p-4.rounded.shadow-sm .d-flex.align-items-center {
    margin-bottom: 8px !important;
    padding-bottom: 4px !important;
    width: 250px !important;
    position: relative !important;
    left: 35px !important;
  }

  .p-4.rounded.shadow-sm h4 {
    font-size: 24px !important;
    margin: 0 !important;
    position: relative !important;
    left: 60px !important;
  }

  .swiper.mySwiper {
    width: 95% !important;
    height: 250px !important;
    margin: 0 auto !important;
  }

  /* 投稿削除ボタン */
  .p-4.rounded.shadow-sm .btn-danger {
    position: static !important;
    width: 110px !important;
    haight: 30px !important;
    font-size: 12px !important;
    padding: 4px !important;
    margin-bottom: 5px !important;
    position: relative !important;
    left: 230px !important;
    top: -65px !important;
  }

  /* ブックマークボタン */
  .btn.bookmark-button {
    width: 110px !important;
    haight: 30px !important;
    font-size: 12px !important;
    padding: 4px !important;
    margin-bottom: 5px !important;
    position: relative !important;
    left: 0px !important;
  }

  /* ブックマーク一覧ボタン */
  .btn.w-100 {
    width: 110px !important;
    haight: 30px !important;
    font-size: 12px !important;
    padding: 4px !important;
    margin-bottom: 5px !important;
    position: relative !important;
    left: 115px !important;
    top: -32px !important;
  }


  /* 感性評価ボタン群 */
  .d-flex.flex-wrap.gap-3 {
    display: flex !important;
    flex-direction: row !important;     /* 横方向 */
    justify-content: center !important; /* 中央寄せ */
    gap: 8px !important;                /* ボタン間の余白 */
    flex-wrap: wrap;                    /* はみ出す場合は折り返し */
    margin: 20px 10px 0px 0px !important;
  }

  /* ボタンの調整 */
  .kind-button {
    width: auto !important;             /* 横並び用に幅を自動に */
    flex: 1;                            /* 均等に広げたい場合 */
    font-size: 14px !important;
    padding: 6px 12px !important;
  }

  /* form_with が block 要素なので横並びにする */
  .d-flex.flex-wrap.gap-3 form {
    display: inline-block !important;
    margin: 0; /* 不要な余白を消す */
  }

  /* 星評価 */
  .star-rating {
    font-size: 18px !important;
    margin-top: 10px !important;
  }

  /* お部屋説明 */
  .rounded-4.shadow-sm.p-2.mb-5 {
    padding: 5px 10px !important;
    font-size: 14px !important;
    margin: 0 10px 20px 10px !important;
    line-height: 0 !important;
  }

  /* オススメグッズカード */
  h2.fw-bold.mb-4 {
    font-size: 28px !important;  /* スマホでは小さめに */
    text-align: start !important; /* 中央寄せもおすすめ */
    margin-bottom: 1rem !important;
  }

  .d-flex.gap-4.align-items-center.p-4.shadow-sm.rounded.mx-auto.mb-0 {
    flex-direction: column !important;  /* 横並び → 縦並び */
    align-items: stretch !important;    /* 高さ方向に広げる */
    height: auto !important;            /* 親の高さ制限を解除 */
    width: 100% !important;
    maragin: 0 10px 0 10px !important;
  }


  .d-flex.gap-4.align-items-center.p-4.shadow-sm.rounded.mx-auto.mb-0 > div:first-child {
    width: 100% !important;
    height: auto !important;
  }

  .d-flex.gap-4.align-items-center.p-4.shadow-sm.rounded.mx-auto.mb-0 img {
    width: 100% !important;
    height: 200px !important;           /* スマホでは画像を大きく */
    object-fit: cover !important;
  }

  .product-card {
    flex-direction: column !important;
    height: auto !important;
    width: 100% !important;
    align-items: center !important;
  }

  .product-image-wrapper {
    width: 100% !important;
    height: auto !important;
    flex-shrink: 1 !important;
  }

  .product-image {
    width: 100% !important;
    height: 200px !important; /* ← スマホでは大きく見せる */
    object-fit: cover !important;
  }
  .product-text-area {
    width: 100% !important;
    padding-top: 1rem;
  }



  /* コメントフォーム */
  #comment-form {
    width: 95% !important;
    margin: 20px auto !important;
  }

  #comment-form .form-control {
    font-size: 14px !important;
  }

  /* コメント一覧 */
  #comment-list .p-3.rounded.shadow-sm {
    font-size: 14px !important;
    margin: 10px auto !important;
    width: 95% !important;
  }

  /* ブックマークボタン */
  .bookmark-button {
    width: 100% !important;
    font-size: 14px !important;
    padding: 10px !important;
  }
}
</style>