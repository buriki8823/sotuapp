<% @post ||= Post.new %>

<% if flash[:error] %>
  <div class="alert alert-danger" style="width: 1700px; margin: 0 auto; margin-bottom: 40px;">
    <p><%= flash[:error] %></p>
  </div>
<% end %>

<div class="position-relative py-0" style="background-image: url(<%= asset_path('posts-bg.png') %>);background-size: cover; background-position: top center; background-repeat: no-repeat; width: 100%; min-height: 100vh; margin: 0;">
  <div class="position-relative">
    <h1 class="toukou-title text-center  mb-5" style="position: relative; top: 30px; font-size: 128px;">投稿</h1>

    <div style="position: absolute; top: 0; right: 0; z-index: 10;">
      <%= render "shared/navigation_box" %>
    </div>
  </div>

  <div class="position-relative">
  <%= form_with model: @post, local: true, html: { multipart: true } do |f| %>
    <!-- タイトル -->
    <div style="width: 1300px; margin: 0 auto; margin-bottom: 50px;">
      <%= f.label :title, "タイトル", style: "font-size: 64px;", class: "form-label d-block text-start mb-1" %>
      <%= f.text_field :title, class: "form-control", style: "height: 65px;",maxlength: 10, placeholder: "タイトル（10文字以内）" %>
    </div>

    <div class="mb-3" style="width: 1300px; margin: 0 auto; ">
      <label class="form-label d-block text-start mb-1" style="font-size: 64px;">評価機能</label>
      <div class="form-check form-check-inline" style="transform: scale(2.0); margin-top: 30px; margin-left: 40px; margin-right: 100px;">
        <%= f.radio_button :rating_enabled, 'true', checked: true, class: "form-check-input", id: "rating_on" %>
        <%= f.label :rating_enabled, "ON", class: "form-check-label", for: "rating_on" %>
      </div>

      <div class="form-check form-check-inline" style="transform: scale(2.0);">
        <%= f.radio_button :rating_enabled, 'false', class: "form-check-input", id: "rating_off" %>
        <%= f.label :rating_enabled, "OFF", class: "form-check-label", for: "rating_off" %>
      </div>
    </div>

  <!-- 画像 -->
  <div class="mb-3" style="width: 1300px; margin: 0 auto; margin-top: 50px;">
    <label class="form-label d-block text-start mb-1" style="font-size: 64px;">画像</label>
  </div>

  <div class="d-flex gap-5 flex-wrap justify-content-start my-4" style="width: 1300px; margin: 0 auto; padding-bottom: 50px;">
    <div class="image-slot-wrapper" data-index="0">
      <div class="image-slot rounded-3 border" id="image-slot-0"
           style="width: 200px; height: 200px; background-color: white; display: flex; align-items: center; justify-content: center;">
        <% if @post.image_urls&.[](0).present? %>
          <% transformed_url_0 = @post.image_urls[0].sub('/upload/', '/upload/c_fit,w_200,h_200/') %>
          <img src="<%= transformed_url_0 %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
        <% else %>
          <span style="color: #aaa;">クリックで画像を挿入</span>
        <% end %>
      </div>
    </div>

    <div class="image-slot-wrapper" data-index="1">
      <div class="image-slot rounded-3 border" id="image-slot-1"
           style="width: 200px; height: 200px; background-color: white; display: flex; align-items: center; justify-content: center;">
        <% if @post.image_urls&.[](1).present? %>
          <% transformed_url_1 = @post.image_urls[1].sub('/upload/', '/upload/c_fit,w_200,h_200/') %>
          <img src="<%= transformed_url_1 %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
        <% else %>
          <span style="color: #aaa;">クリックで画像を挿入</span>
        <% end %>
      </div>
    </div>

    <div class="image-slot-wrapper" data-index="2">
      <div class="image-slot rounded-3 border" id="image-slot-2"
           style="width: 200px; height: 200px; background-color: white; display: flex; align-items: center; justify-content: center;">
        <% if @post.image_urls&.[](2).present? %>
          <% transformed_url_2 = @post.image_urls[2].sub('/upload/', '/upload/c_fit,w_200,h_200/') %>
          <img src="<%= transformed_url_2 %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
        <% else %>
          <span style="color: #aaa;">クリックで画像を挿入</span>
        <% end %>
      </div>
    </div>

    <div class="image-slot-wrapper" data-index="3">
      <div class="image-slot rounded-3 border" id="image-slot-3"
           style="width: 200px; height: 200px; background-color: white; display: flex; align-items: center; justify-content: center;">
        <% if @post.image_urls&.[](3).present? %>
          <% transformed_url_3 = @post.image_urls[3].sub('/upload/', '/upload/c_fit,w_200,h_200/') %>
          <img src="<%= transformed_url_3 %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
        <% else %>
          <span style="color: #aaa;">クリックで画像を挿入</span>
        <% end %>
      </div>
    </div>

    <div class="image-slot-wrapper" data-index="4">
      <div class="image-slot rounded-3 border" id="image-slot-4"
           style="width: 200px; height: 200px; background-color: white; display: flex; align-items: center; justify-content: center;">
        <% if @post.image_urls&.[](4).present? %>
          <% transformed_url_4 = @post.image_urls[4].sub('/upload/', '/upload/c_fit,w_200,h_200/') %>
          <img src="<%= transformed_url_4 %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
        <% else %>
          <span style="color: #aaa;">クリックで画像を挿入</span>
        <% end %>
      </div>
    </div>
  </div>

    <%= hidden_field_tag "post[image_urls][]", "", id: "image-url-0" %>
    <%= hidden_field_tag "post[image_urls][]", "", id: "image-url-1" %>
    <%= hidden_field_tag "post[image_urls][]", "", id: "image-url-2" %>
    <%= hidden_field_tag "post[image_urls][]", "", id: "image-url-3" %>
    <%= hidden_field_tag "post[image_urls][]", "", id: "image-url-4" %>

  


    <!-- 概要 -->
    <div style="width: 1300px; margin: 0 auto; margin-bottom: 100px;">
      <%= f.label :body, "概要", style: "font-size: 64px;" %>
      <%= f.text_area :body, class: "form-control", rows: 20, style: "height: 400px; font-size: 24px;", placeholder: "概要（200文字以内）" %>
    </div>

    <!-- オススメグッズ -->
    <div style="width: 1300px; margin: 0 auto; margin-bottom: 100px;">
      <div>
        <%= label_tag :products, "オススメグッズ", style: "font-size: 64px; display: block;" %>
        <%= label_tag :products, "※紹介したいグッズがあれば挿入してください", style: "font-size: 32px; display: block; margin-top: 10px;" %>
      </div>
    </div>

    <div class="d-flex gap-5 flex-wrap justify-content-start my-4" style="width: 1300px; margin: 0 auto; padding-bottom: 50px;">
      <%= f.fields_for :products do |pf| %>
        <div class="d-flex flex-column align-items-center" style="width: 200px;">
          <!-- 表示枠（クリックでモーダル） -->
          <div class="product-slot rounded-3 border position-relative"
               data-index="<%= pf.index %>"
               style="width: 200px; height: 200px; background-color: #f8f9fa; cursor: pointer; display: flex; align-items: center; justify-content: center;">
            <span style="color: #aaa; font-size: 24px;">オススメ商品を挿入</span>
          </div>

          <!-- hidden input群（form送信対象） -->
          <div class="product-fields d-none">
            <%= pf.text_field :title, id: "product-title-#{pf.index}" %>
            <%= pf.text_area :description, id: "product-description-#{pf.index}" %>
            <%= pf.text_field :url, id: "product-url-#{pf.index}" %>
            <%= pf.hidden_field :image_url, id: "product-image-url-#{pf.index}" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- モーダル本体 -->
    <div id="product-modal" class="position-fixed top-0 start-0 w-100 h-100 align-items-center justify-content-center"
         style="background-color: rgba(0,0,0,0.5); z-index: 9999; display: none;">
      <div class="rounded-4 p-5" style="width: 800px; max-height: 70vh; overflow-y: auto; background-color: #E7EEEE;">
        <h2 class="mb-4" style="font-size: 24px;">オススメの商品を追加してください</h2>

        <div class="mb-3">
          <label for="modal-title" class="form-label">タイトル</label>
          <input type="text" id="modal-title" class="form-control">
        </div>

        <div class="mb-3">
          <label for="modal-description" class="form-label">商品説明</label>
          <textarea id="modal-description" class="form-control" rows="4"></textarea>
        </div>

        <div class="mb-3">
          <label for="modal-url" class="form-label">商品ページ（リンク）</label>
          <input type="text" id="modal-url" class="form-control" placeholder="https://example.com">
        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="button" id="modal-image-upload"
                class="btn"
                style="margin-right: 380px; border: 2px solid #a8e063; color: #a8e063; background-color: transparent;"
                onmouseover="this.style.backgroundColor='#a8e063'; this.style.color='#fff';"
                onmouseout="this.style.backgroundColor='transparent'; this.style.color='#a8e063';">
          画像をアップロード
          </button>
          <button type="button" id="modal-ok" class="btn btn-primary" >OK</button>
          <button type="button" id="modal-cancel" class="btn btn-secondary" style="margin-left: 15px;">キャンセル</button>
        </div>

        <div id="modal-image-preview" class="mt-3" style="height: 400px; border: 1px solid #ccc;">
          <% transformed_url = @post.image_urls&.first&.sub('/upload/', '/upload/c_fill,w_500,h_400,g_auto/') %>
          <%= image_tag(transformed_url || asset_path('placeholder.png'), style: "width: 100%; height: 100%; object-fit: cover;") %>
        </div>
      </div>
    </div>

    <!-- 投稿ボタン -->
    <div class="text-center mt-4" style="position: relative; top: -50px;">
      <%= f.submit "投稿する",
          id: "post-submit-button",
          class: "btn",
          style: "background-color: #a8e063; color: #fff; border: none; padding: 20px 40px; font-size: 32px;",
          data: { turbo: false } %>
    </div>
  <% end %>
  </div>
</div>

<% content_for :footer do %>
  <div style="display: none;"></div>
<% end %>